{% extends "base.html" %}

{% block title %}AO3 Tracker – Job {{ job.id }}{% endblock %}

{% block content %}
<h1>Download Job #{{ job.id }}</h1>

<div style="margin-bottom: 20px;">
    <a href="/downloader">← Back to Downloader</a>
</div>

<div style="padding: 20px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 20px;">
    <h2>Job Details</h2>
    <table>
        <tr>
            <td><strong>Type:</strong></td>
            <td>{{ job.job_type }}</td>
        </tr>
        <tr>
            <td><strong>Status:</strong></td>
            <td>
                <span style="padding: 4px 8px; border-radius: 4px; 
                    {% if job.status == 'completed' %}background-color: #d4edda; color: #155724;
                    {% elif job.status == 'failed' %}background-color: #f8d7da; color: #721c24;
                    {% elif job.status == 'running' %}background-color: #d1ecf1; color: #0c5460;
                    {% elif job.status == 'cancelled' %}background-color: #e2e3e5; color: #383d41;
                    {% else %}background-color: #fff3cd; color: #856404;{% endif %}">
                    {{ job.status }}
                </span>
                {% if job.status == 'running' or job.status == 'pending' %}
                <button 
                    id="cancel-btn" 
                    onclick="cancelJob()" 
                    style="margin-left: 10px; padding: 4px 12px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;"
                >
                    Stop Job
                </button>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td><strong>Created:</strong></td>
            <td>{{ job.created_at }}</td>
        </tr>
        {% if job.started_at %}
        <tr>
            <td><strong>Started:</strong></td>
            <td>{{ job.started_at }}</td>
        </tr>
        {% endif %}
        {% if job.completed_at %}
        <tr>
            <td><strong>Completed:</strong></td>
            <td>{{ job.completed_at }}</td>
        </tr>
        {% endif %}
    </table>
</div>

{% if job.progress_message or job.status == 'running' %}
<div style="padding: 15px; background-color: #f8f9fa; border-radius: 6px; margin-bottom: 20px;">
    <h3>Progress</h3>
    <p id="progress-message">{{ job.progress_message or 'Starting...' }}</p>
    {% if job.status == 'running' %}
    <div style="margin-top: 10px;">
        <div style="width: 100%; height: 4px; background-color: #dee2e6; border-radius: 2px; overflow: hidden;">
            <div style="width: 100%; height: 100%; background-color: #007bff; animation: pulse 2s infinite;"></div>
        </div>
    </div>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
    {% endif %}
</div>
{% endif %}

{% if job.parameters %}
<div style="padding: 15px; background-color: #f8f9fa; border-radius: 6px; margin-bottom: 20px;">
    <h3>Parameters</h3>
    <pre style="background-color: white; padding: 10px; border-radius: 4px; overflow-x: auto;">{{ job.parameters | tojson(indent=2) }}</pre>
</div>
{% endif %}

{% if job.result %}
<div style="padding: 15px; background-color: #d4edda; border-radius: 6px; margin-bottom: 20px;">
    <h3>Result</h3>
    <pre style="background-color: white; padding: 10px; border-radius: 4px; overflow-x: auto;">{{ job.result | tojson(indent=2) }}</pre>
    {% if job.result.file_path %}
    <p><strong>File:</strong> <code>{{ job.result.file_path }}</code></p>
    {% endif %}
</div>
{% endif %}

{% if job.error_message %}
<div style="padding: 15px; background-color: #f8d7da; border-radius: 6px; margin-bottom: 20px;">
    <h3>Error</h3>
    <p style="color: #721c24;">{{ job.error_message }}</p>
</div>
{% endif %}

{% if job.status == 'running' or job.status == 'pending' %}
<script>
    // Auto-refresh progress for running jobs
    let refreshInterval;
    
    function updateProgress() {
        fetch('/api/v1/downloader/jobs/{{ job.id }}/progress')
            .then(response => response.json())
            .then(data => {
                const progressEl = document.getElementById('progress-message');
                if (progressEl && data.progress) {
                    progressEl.textContent = data.progress;
                }
            })
            .catch(err => console.error('Error fetching progress:', err));
    }
    
    function cancelJob() {
        if (!confirm('Are you sure you want to cancel this job?')) {
            return;
        }
        
        const btn = document.getElementById('cancel-btn');
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'Cancelling...';
        }
        
        fetch('/api/v1/downloader/jobs/{{ job.id }}/cancel', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Reload page to show cancelled status
                setTimeout(() => {
                    location.reload();
                }, 500);
            } else {
                alert('Failed to cancel job: ' + (data.detail || 'Unknown error'));
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Stop Job';
                }
            }
        })
        .catch(err => {
            console.error('Error cancelling job:', err);
            alert('Error cancelling job: ' + err.message);
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Stop Job';
            }
        });
    }
    
    // Update progress every 2 seconds
    refreshInterval = setInterval(updateProgress, 2000);
    
    // Also reload page every 10 seconds to get full status update
    setTimeout(function() {
        location.reload();
    }, 10000);
</script>
{% endif %}

{% endblock %}

